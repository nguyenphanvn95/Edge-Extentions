var e,t;"function"==typeof(e=globalThis.define)&&(t=e,e=null),function(e,t,i,n,a){var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},s="function"==typeof r[n]&&r[n],l=s.cache||{},o="undefined"!=typeof module&&"function"==typeof module.require&&module.require.bind(module);function u(t,i){if(!l[t]){if(!e[t]){var a="function"==typeof r[n]&&r[n];if(!i&&a)return a(t,!0);if(s)return s(t,!0);if(o&&"string"==typeof t)return o(t);var c=Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}m.resolve=function(i){var n=e[t][1][i];return null!=n?n:i},m.cache={};var h=l[t]=new u.Module(t);e[t][0].call(h.exports,m,h,h.exports,this)}return l[t].exports;function m(e){var t=m.resolve(e);return!1===t?{}:u(t)}}u.isParcelRequire=!0,u.Module=function(e){this.id=e,this.bundle=u,this.exports={}},u.modules=e,u.cache=l,u.parent=s,u.register=function(t,i){e[t]=[function(e,t){t.exports=i},{}]},Object.defineProperty(u,"root",{get:function(){return r[n]}}),r[n]=u;for(var c=0;c<t.length;c++)u(t[c])}({dfXNh:[function(e,t,i){var n=e("@parcel/transformer-js/src/esmodule-helpers.js");n.defineInteropFlag(i),n.export(i,"StuffDocumentsChain",()=>l),n.export(i,"MapReduceDocumentsChain",()=>o),n.export(i,"RefineDocumentsChain",()=>u);var a=e("./base.js"),r=e("./llm_chain.js"),s=e("../prompts/prompt.js");class l extends a.BaseChain{static lc_name(){return"StuffDocumentsChain"}get inputKeys(){return[this.inputKey,...this.llmChain.inputKeys].filter(e=>e!==this.documentVariableName)}get outputKeys(){return this.llmChain.outputKeys}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),this.llmChain=e.llmChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.inputKey=e.inputKey??this.inputKey}_prepInputs(e){if(!(this.inputKey in e))throw Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:t,...i}=e,n=t.map(({pageContent:e})=>e).join("\n\n");return{...i,[this.documentVariableName]:n}}async _call(e,t){return await this.llmChain.call(this._prepInputs(e),t?.getChild("combine_documents"))}_chainType(){return"stuff_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw Error("Missing llm_chain");return new l({llmChain:await (0,r.LLMChain).deserialize(e.llm_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize()}}}class o extends a.BaseChain{static lc_name(){return"MapReduceDocumentsChain"}get inputKeys(){return[this.inputKey,...this.combineDocumentChain.inputKeys]}get outputKeys(){return this.combineDocumentChain.outputKeys}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"returnIntermediateSteps",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:3e3}),Object.defineProperty(this,"maxIterations",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(this,"ensureMapStep",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"combineDocumentChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmChain=e.llmChain,this.combineDocumentChain=e.combineDocumentChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.ensureMapStep=e.ensureMapStep??this.ensureMapStep,this.inputKey=e.inputKey??this.inputKey,this.maxTokens=e.maxTokens??this.maxTokens,this.maxIterations=e.maxIterations??this.maxIterations,this.returnIntermediateSteps=e.returnIntermediateSteps??!1}async _call(e,t){if(!(this.inputKey in e))throw Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:i,...n}=e,a=i,r=[];for(let e=0;e<this.maxIterations;e+=1){let i=a.map(e=>({[this.documentVariableName]:e.pageContent,...n}));if(0!==e||!this.ensureMapStep){let e=await this.combineDocumentChain.llmChain.prompt.format(this.combineDocumentChain._prepInputs({[this.combineDocumentChain.inputKey]:a,...n}));if(await this.combineDocumentChain.llmChain._getNumTokens(e)<this.maxTokens)break}let s=await this.llmChain.apply(i,t?Array.from({length:i.length},(e,i)=>t.getChild(`map_${i+1}`)):void 0),{outputKey:l}=this.llmChain;this.returnIntermediateSteps&&(r=r.concat(s.map(e=>e[l]))),a=s.map(e=>({pageContent:e[l],metadata:{}}))}let s={[this.combineDocumentChain.inputKey]:a,...n},l=await this.combineDocumentChain.call(s,t?.getChild("combine_documents"));return this.returnIntermediateSteps?{...l,intermediateSteps:r}:l}_chainType(){return"map_reduce_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw Error("Missing llm_chain");if(!e.combine_document_chain)throw Error("Missing combine_document_chain");return new o({llmChain:await (0,r.LLMChain).deserialize(e.llm_chain),combineDocumentChain:await l.deserialize(e.combine_document_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),combine_document_chain:this.combineDocumentChain.serialize()}}}class u extends a.BaseChain{static lc_name(){return"RefineDocumentsChain"}get defaultDocumentPrompt(){return new s.PromptTemplate({inputVariables:["page_content"],template:"{page_content}"})}get inputKeys(){return[...new Set([this.inputKey,...this.llmChain.inputKeys,...this.refineLLMChain.inputKeys])].filter(e=>e!==this.documentVariableName&&e!==this.initialResponseName)}get outputKeys(){return[this.outputKey]}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output_text"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"initialResponseName",{enumerable:!0,configurable:!0,writable:!0,value:"existing_answer"}),Object.defineProperty(this,"refineLLMChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"documentPrompt",{enumerable:!0,configurable:!0,writable:!0,value:this.defaultDocumentPrompt}),this.llmChain=e.llmChain,this.refineLLMChain=e.refineLLMChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.inputKey=e.inputKey??this.inputKey,this.outputKey=e.outputKey??this.outputKey,this.documentPrompt=e.documentPrompt??this.documentPrompt,this.initialResponseName=e.initialResponseName??this.initialResponseName}async _constructInitialInputs(e,t){let i={page_content:e.pageContent,...e.metadata},n={};return this.documentPrompt.inputVariables.forEach(e=>{n[e]=i[e]}),{[this.documentVariableName]:await this.documentPrompt.format({...n}),...t}}async _constructRefineInputs(e,t){let i={page_content:e.pageContent,...e.metadata},n={};this.documentPrompt.inputVariables.forEach(e=>{n[e]=i[e]});let a={[this.documentVariableName]:await this.documentPrompt.format({...n})};return{[this.initialResponseName]:t,...a}}async _call(e,t){if(!(this.inputKey in e))throw Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:i,...n}=e,a=await this._constructInitialInputs(i[0],n),r=await this.llmChain.predict({...a},t?.getChild("answer")),s=[r];for(let e=1;e<i.length;e+=1){let a={...await this._constructRefineInputs(i[e],r),...n};r=await this.refineLLMChain.predict({...a},t?.getChild("refine")),s.push(r)}return{[this.outputKey]:r}}_chainType(){return"refine_documents_chain"}static async deserialize(e){let t=e.llm_chain;if(!t)throw Error("Missing llm_chain");let i=e.refine_llm_chain;if(!i)throw Error("Missing refine_llm_chain");return new u({llmChain:await (0,r.LLMChain).deserialize(t),refineLLMChain:await (0,r.LLMChain).deserialize(i)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),refine_llm_chain:this.refineLLMChain.serialize()}}}},{"./base.js":"lOD6l","./llm_chain.js":"dLYP0","../prompts/prompt.js":"9S6vM","@parcel/transformer-js/src/esmodule-helpers.js":"jb2Oh"}],"9S6vM":[function(e,t,i){var n=e("@parcel/transformer-js/src/esmodule-helpers.js");n.defineInteropFlag(i),n.export(i,"PromptTemplate",()=>a.PromptTemplate);var a=e("@langchain/core/prompts")},{"@langchain/core/prompts":"jpJY6","@parcel/transformer-js/src/esmodule-helpers.js":"jb2Oh"}]},[],0,"parcelRequire3d47"),globalThis.define=t;